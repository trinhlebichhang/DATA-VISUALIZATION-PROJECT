<!DOCTYPE html>
<html lang="en"></html>
<head>
<meta charset="UTF-8">
<title>Sales Performance Dashboard</title>
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #0b2c6b;
  color: white;
}
h1 {
  margin: 20px;
  text-align: center;
  background: white;
  color: #0b2c6b;
  padding: 12px;
  border-radius: 12px;
}
.kpi-container {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
  margin: 20px;
}
.kpi-card {
  background: white;
  color: #0b2c6b;
  border-radius: 10px;
  padding: 16px;
  text-align: center;
}
.kpi-value {
  font-size: 28px;
  font-weight: bold;
}
.main-layout {
  display: grid;
  grid-template-columns: 1fr 1fr 260px;
  gap: 20px;
  margin: 20px;
}
.chart-card {
  border: 1px solid #ffffff33;
  border-radius: 10px;
  padding: 10px;
}
.chart-title {
  text-align: center;
  font-weight: bold;
}
.chart-sub {
  text-align: center;
  font-size: 12px;
  opacity: 0.8;
}
.filter-box {
  background: white;
  color: #0b2c6b;
  border-radius: 10px;
  padding: 15px;
}
select {
  width: 100%;
  padding: 6px;
  margin-bottom: 12px;
}
.tooltip {
  position: absolute;
  background: white;
  color: #0b2c6b;
  padding: 8px;
  border-radius: 6px;
  font-size: 12px;
  pointer-events: none;
  opacity: 0;
}
</style>
</head>

<body>

<h1>Sales Performance Dashboard</h1>

<div class="kpi-container">
  <div class="kpi-card"><div id="kpi-revenue" class="kpi-value">$0</div>Total Revenue</div>
  <div class="kpi-card"><div id="kpi-profit" class="kpi-value">$0</div>Total Profit</div>
  <div class="kpi-card"><div id="kpi-margin" class="kpi-value">0%</div>Profit Margin</div>
  <div class="kpi-card"><div id="kpi-orders" class="kpi-value">0</div>Total Orders</div>
</div>

<div class="main-layout">

  <div class="chart-card">
    <div class="chart-title">Revenue</div>
    <div class="chart-sub" id="rev-sub"></div>
    <svg id="revenueChart" width="520" height="320"></svg>
  </div>

  <div class="chart-card">
    <div class="chart-title">Profit</div>
    <div class="chart-sub" id="prof-sub"></div>
    <svg id="profitChart" width="520" height="320"></svg>
  </div>

  <div class="filter-box">
    <h3>Filter</h3>
    <label>Year</label>
    <select id="yearFilter">
      <option value="all">All Years</option>
    </select>
  </div>

</div>

<div class="tooltip" id="tooltip"></div>

<script>
const categories = ["Furniture", "Office Supplies", "Technology"];
const colors = {
  "Furniture": "#9b59b6",
  "Office Supplies": "#f1c40f",
  "Technology": "#1abc9c"
};

const parseDate = d3.timeParse("%d/%m/%Y");
const tooltip = d3.select("#tooltip");

d3.csv("sale_data.csv").then(data => {
  data.forEach(d => {
    d.date = parseDate(d["Order Date"]);
    d.year = d.date.getFullYear();
    d.month = d.date.getMonth();
    d.Sales = +d.Sales;
    d.Profit = +d.Profit;
    d.Order_ID = d["Order ID"];
  });

  buildFilters(data);
  updateDashboard(data);

  d3.select("#yearFilter").on("change", () => updateDashboard(data));
});

function buildFilters(data) {
  [...new Set(data.map(d => d.year))].sort()
    .forEach(y => {
      d3.select("#yearFilter")
        .append("option")
        .attr("value", y)
        .text(y);
    });
}

function updateDashboard(data) {
  const y = d3.select("#yearFilter").property("value");
  let filtered = data;
  if (y !== "all") filtered = filtered.filter(d => d.year === +y);

  updateKPIs(filtered);

  if (y === "all") {
    draw("#revenueChart", aggregate(filtered, "year", "Sales"), "year", "Sales");
    draw("#profitChart", aggregate(filtered, "year", "Profit"), "year", "Profit");
    setSub("All Years");
  } else {
    draw("#revenueChart", aggregate(filtered, "month", "Sales"), "month", "Sales");
    draw("#profitChart", aggregate(filtered, "month", "Profit"), "month", "Profit");
    setSub(`Monthly â€“ ${y}`);
  }
}

function updateKPIs(d) {
  const totalRevenue = d3.sum(d, x => x.Sales);
  const totalProfit = d3.sum(d, x => x.Profit);

  d3.select("#kpi-revenue").text(`$${(totalRevenue / 1000).toFixed(2)}K`);
  d3.select("#kpi-profit").text(`$${(totalProfit / 1000).toFixed(2)}K`);
  d3.select("#kpi-orders").text(new Set(d.map(x => x.Order_ID)).size);
  d3.select("#kpi-margin").text(
    totalRevenue ? `${(totalProfit / totalRevenue * 100).toFixed(2)}%` : "0%"
  );
}

function aggregate(data, key, field) {
  return d3.groups(data, d => d[key])
    .map(([k, rows]) => ({
      [key]: k,
      ...Object.fromEntries(
        categories.map(c => [
          c,
          d3.sum(rows.filter(r => r.Category === c), r => r[field]) || 0
        ])
      )
    }))
    .sort((a, b) => a[key] - b[key]);
}

function draw(id, data, mode, metric) {
  const svg = d3.select(id);
  svg.selectAll("*").remove();

  const margin = { t: 20, r: 20, b: 40, l: 60 };
  const w = +svg.attr("width") - margin.l - margin.r;
  const h = +svg.attr("height") - margin.t - margin.b;

  const g = svg.append("g")
    .attr("transform", `translate(${margin.l},${margin.t})`);

  const x = d3.scaleBand()
    .domain(data.map(d => d[mode]))
    .range([0, w])
    .padding(0.3);

  const y = d3.scaleLinear()
    .domain([0, d3.max(data, d => categories.reduce((s, c) => s + d[c], 0))])
    .nice()
    .range([h, 0]);

  const stack = d3.stack().keys(categories)(data);

  const area = d3.area()
    .x(d => x(d.data[mode]) + x.bandwidth() / 2)
    .y0(d => y(d[0]))
    .y1(d => y(d[1]));

  g.selectAll("path")
    .data(stack)
    .enter()
    .append("path")
    .attr("fill", d => colors[d.key])
    .attr("d", area)
    .on("mousemove", (e, d) => {
      const v = d.data[d.key];
      tooltip
        .style("opacity", 1)
        .html(`<b>${d.key}</b><br>${metric}: $${d3.format(",.2f")(v)}`)
        .style("left", (e.pageX + 10) + "px")
        .style("top", (e.pageY - 20) + "px");
    })
    .on("mouseout", () => tooltip.style("opacity", 0));

  g.append("g")
    .attr("transform", `translate(0,${h})`)
    .call(d3.axisBottom(x).tickFormat(v => {
      if (mode === "month") return d3.timeFormat("%b")(new Date(2020, v, 1));
      return v;
    }));

  g.append("g").call(d3.axisLeft(y));

  drawLegend(svg, w);
}

function drawLegend(svg, width) {
  const legend = svg.append("g")
    .attr("transform", `translate(${width - 380},10)`);

  categories.forEach((c, i) => {
    const g = legend.append("g")
      .attr("transform", `translate(${i * 130},0)`);

    g.append("rect").attr("width", 12).attr("height", 12).attr("fill", colors[c]);
    g.append("text").attr("x", 18).attr("y", 11).attr("fill", "white").text(c);
  });
}

function setSub(t) {
  d3.select("#rev-sub").text(t);
  d3.select("#prof-sub").text(t);
}
</script>

</body>
</html>
